{% extends "base.html" %}

{% block title %}Reporte de Ganancias{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold mb-0"><i class="bi bi-graph-up-arrow me-2 text-success"></i> Reporte de Ganancias</h2>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary rounded-pill px-4">
        <i class="bi bi-arrow-left me-1"></i> Volver al Inicio
    </a>
</div>

<!-- ====== PANEL DE FILTROS ====== -->
<div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-body p-3">
        <form method="GET" action="{{ url_for('reporte_ganancias') }}">
            <div class="row g-2 align-items-end">
                <div class="col-12 col-md-3">
                    <label class="form-label text-muted small fw-semibold mb-1">Fecha Inicio</label>
                    <input type="date" class="form-control border-0 bg-light" name="fecha_inicio"
                        value="{{ fecha_inicio or '' }}">
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label text-muted small fw-semibold mb-1">Fecha Fin</label>
                    <input type="date" class="form-control border-0 bg-light" name="fecha_fin"
                        value="{{ fecha_fin or '' }}">
                </div>
                <div class="col-12 col-md-2">
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">
                        <i class="bi bi-filter me-1"></i> Filtrar
                    </button>
                </div>
                <div class="col-12 col-md-2">
                    <a href="{{ url_for('reporte_ganancias') }}" class="btn btn-light text-muted w-100 rounded-pill">
                        <i class="bi bi-x-circle me-1"></i> Limpiar
                    </a>
                </div>
                <div class="col-12 col-md-2">
                    <a href="{{ url_for('reporte_ganancias_exportar', fecha_inicio=fecha_inicio or '', fecha_fin=fecha_fin or '') }}"
                        class="btn btn-success w-100 rounded-pill">
                        <i class="bi bi-file-earmark-excel me-1"></i> Exportar Excel
                    </a>
                </div>
                <div class="col-12 col-md-2">
                    <button type="button" class="btn btn-outline-primary w-100 rounded-pill"
                            data-bs-toggle="modal" data-bs-target="#modalImportarPedidos">
                        <i class="bi bi-upload me-1"></i> Importar
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- ====== MODAL IMPORTAR PEDIDOS ====== -->
<div class="modal fade" id="modalImportarPedidos" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-upload me-2 text-primary"></i>Importar Fechas y Gastos de Envío
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST"
                  action="{{ url_for('reporte_ganancias_importar_pedidos', fecha_inicio=fecha_inicio or '', fecha_fin=fecha_fin or '') }}"
                  enctype="multipart/form-data">
                <div class="modal-body pt-3">
                    <p class="text-muted small mb-3">
                        El Excel debe tener estas columnas (sin importar mayúsculas ni acentos):
                    </p>
                    <div class="bg-light rounded-3 p-3 mb-3 font-monospace small">
                        <div class="text-muted">Numero de orden &nbsp;|&nbsp; Fecha de creacion &nbsp;|&nbsp; Costo de envio</div>
                        <div>12345 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| 2024-01-15 10:30 &nbsp;&nbsp;&nbsp;| 15.90</div>
                        <div>12346 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| 2024-01-16 09:00 &nbsp;&nbsp;&nbsp;| 0.00</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold small">Archivo Excel</label>
                        <input type="file" class="form-control" name="file" accept=".xlsx,.xls" required>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4">
                        <i class="bi bi-upload me-1"></i> Importar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ====== TARJETAS DE RESUMEN ====== -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white h-100 border-0 shadow-sm glass-panel">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-white-50 mb-1">Total Ingresos</h6>
                        <h3 class="mb-0 fw-bold">S/ {{ "%.2f"|format(totales.ingresos) }}</h3>
                    </div>
                    <div class="fs-1 opacity-50"><i class="bi bi-cash-stack"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-danger text-white h-100 border-0 shadow-sm glass-panel">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-white-50 mb-1">Costo Productos</h6>
                        <h4 class="mb-0 fw-bold">S/ {{ "%.2f"|format(totales.costos) }}</h4>
                    </div>
                    <div class="fs-1 opacity-50"><i class="bi bi-box-seam"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-warning text-dark h-100 border-0 shadow-sm glass-panel">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Gasto Envío</h6>
                        <h4 class="mb-0 fw-bold">S/ {{ "%.2f"|format(totales.costos_envio|default(0.0)) }}</h4>
                    </div>
                    <div class="fs-1 opacity-50"><i class="bi bi-truck"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white h-100 border-0 shadow-sm glass-panel">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-white-50 mb-1">Ganancia Bruta</h6>
                        <h3 class="mb-0 fw-bold">S/ {{ "%.2f"|format(totales.ganancia) }}</h3>
                    </div>
                    <div class="fs-1 opacity-50"><i class="bi bi-graph-up-arrow"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-info text-white h-100 border-0 shadow-sm glass-panel">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-white-50 mb-1">Margen Prom.</h6>
                        <h3 class="mb-0 fw-bold">{{ "%.1f"|format(totales.margen) }}%</h3>
                    </div>
                    <div class="fs-1 opacity-50"><i class="bi bi-percent"></i></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% macro sort_th_r(label, col, extra_class='') %}
{% if sort == col and sort_dir == 'desc' %}
    {% set next_href = url_for('reporte_ganancias', fecha_inicio=fecha_inicio, fecha_fin=fecha_fin, sort=col, dir='asc', page=1) %}
    {% set is_active = true %}
    {% set icon_class = 'bi-arrow-down' %}
{% elif sort == col and sort_dir == 'asc' %}
    {% set next_href = url_for('reporte_ganancias', fecha_inicio=fecha_inicio, fecha_fin=fecha_fin, page=1) %}
    {% set is_active = true %}
    {% set icon_class = 'bi-arrow-up' %}
{% else %}
    {% set next_href = url_for('reporte_ganancias', fecha_inicio=fecha_inicio, fecha_fin=fecha_fin, sort=col, dir='desc', page=1) %}
    {% set is_active = false %}
    {% set icon_class = 'bi-arrow-down-up' %}
{% endif %}
<th class="py-3 {{ extra_class }}">
    <a href="{{ next_href }}"
       class="sort-link-r {{ 'text-primary fw-semibold' if is_active else 'text-muted' }}">
        {{ label }}
        <i class="bi {{ icon_class }} ms-1 {{ '' if is_active else 'opacity-25' }}"></i>
    </a>
</th>
{% endmacro %}

<!-- ====== TABLA DETALLADA ====== -->
<div class="card border-0 shadow-sm rounded-4 glass-panel mb-4 overflow-hidden">
    <div class="table-responsive">
        <table class="table table-hover table-borderless align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    {{ sort_th_r('Orden', 'orden', 'ps-4') }}
                    <th class="py-3">Docs. Emitidos</th>
                    {{ sort_th_r('Fecha', 'fecha') }}
                    {{ sort_th_r('Ingreso', 'ingreso', 'text-end') }}
                    {{ sort_th_r('Costo Productos', 'costo_total', 'text-end') }}
                    {{ sort_th_r('Gasto Envío', 'costo_envio', 'text-end') }}
                    {{ sort_th_r('Ganancia', 'ganancia', 'text-end') }}
                    {{ sort_th_r('Margen', 'margen', 'text-end pe-4') }}
                </tr>
            </thead>
            <tbody>
                {% for fila in datos %}
                <tr class="border-bottom border-light">
                    <td class="ps-4 fw-semibold text-primary">
                        {% if fila.venta.numero_orden %}
                        #{{ fila.venta.numero_orden }}
                        {% else %}
                        <span class="text-muted small">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if fila.venta.pdf_path %}
                        <a href="{{ url_for('descargar_pdf', venta_id=fila.venta.id) }}" target="_blank"
                            class="text-decoration-none me-1" title="PDF">
                            <i class="bi bi-file-earmark-pdf text-danger"></i>
                        </a>
                        {% endif %}
                        {{ fila.venta.numero_completo }}
                    </td>
                    <td class="text-muted small">{{ fila.fecha_real.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td class="text-end fw-semibold text-primary">S/ {{ "%.2f"|format(fila.venta.total) }}</td>
                    <td class="text-end text-danger">S/ {{ "%.2f"|format(fila.costo_total) }}</td>
                    <td class="text-end text-warning-emphasis">S/ {{ "%.2f"|format(fila.costo_envio) }}</td>
                    <td class="text-end fw-bold text-success">S/ {{ "%.2f"|format(fila.ganancia) }}</td>
                    <td class="text-end pe-4">
                        <span
                            class="badge {% if fila.margen >= 30 %}bg-success-subtle text-success{% elif fila.margen >= 10 %}bg-warning-subtle text-warning{% else %}bg-danger-subtle text-danger{% endif %} rounded-pill">
                            {{ "%.1f"|format(fila.margen) }}%
                        </span>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center py-5 text-muted">
                        <i class="bi bi-inbox fs-1 d-block mb-3 opacity-50"></i>
                        No hay datos de ventas en este rango de fechas.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ====== PAGINACIÓN ====== -->
    {% if total_pages > 1 %}
    <div class="d-flex justify-content-between align-items-center px-4 py-3 border-top bg-light bg-opacity-50">
        <span class="text-muted small">
            Mostrando <strong>{{ (page - 1) * 25 + 1 }}–{{ [page * 25, total_items] | min }}</strong>
            de <strong>{{ total_items }}</strong> ventas
        </span>
        <nav>
            <ul class="pagination pagination-sm mb-0 gap-1">
                <li class="page-item {{ 'disabled' if page == 1 }}">
                    <a class="page-link rounded-3 border-0"
                       href="{{ url_for('reporte_ganancias', fecha_inicio=fecha_inicio, fecha_fin=fecha_fin, sort=sort, dir=sort_dir, page=page-1) if page > 1 else '#' }}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
                {% for p in range(1, total_pages + 1) %}
                    {% if p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                        <li class="page-item {{ 'active' if p == page }}">
                            <a class="page-link rounded-3 border-0 fw-semibold"
                               href="{{ url_for('reporte_ganancias', fecha_inicio=fecha_inicio, fecha_fin=fecha_fin, sort=sort, dir=sort_dir, page=p) }}">
                                {{ p }}
                            </a>
                        </li>
                    {% elif p == 2 or p == total_pages - 1 %}
                        <li class="page-item disabled"><span class="page-link border-0 bg-transparent px-1">…</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {{ 'disabled' if page == total_pages }}">
                    <a class="page-link rounded-3 border-0"
                       href="{{ url_for('reporte_ganancias', fecha_inicio=fecha_inicio, fecha_fin=fecha_fin, sort=sort, dir=sort_dir, page=page+1) if page < total_pages else '#' }}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<style>
    .bg-info-subtle {
        background-color: rgba(13, 202, 240, 0.12) !important;
    }

    .bg-success-subtle {
        background-color: rgba(25, 135, 84, 0.1) !important;
    }

    .bg-warning-subtle {
        background-color: rgba(255, 193, 7, 0.12) !important;
    }

    .bg-danger-subtle {
        background-color: rgba(220, 53, 69, 0.1) !important;
    }

    .bg-secondary-subtle {
        background-color: rgba(108, 117, 125, 0.1) !important;
    }

    .bg-primary-subtle {
        background-color: rgba(13, 110, 253, 0.1) !important;
    }

    .sort-link-r {
        text-decoration: none;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        display: inline-flex;
        align-items: center;
        gap: 2px;
        transition: color 0.15s;
        white-space: nowrap;
    }
    .sort-link-r:hover { color: #0d6efd !important; }
    .sort-link-r i { font-size: 0.65rem; }

    .pagination .page-link {
        background-color: #fff;
        color: #6c757d;
        min-width: 32px;
        text-align: center;
        transition: all 0.15s;
    }
    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        color: #fff;
    }
    .pagination .page-link:hover:not(.disabled) {
        background-color: #e9f0ff;
        color: #0d6efd;
    }
</style>

<script>
    // ====== RESET SORT ON BROWSER RELOAD ======
    (function () {
        const nav = performance.getEntriesByType('navigation')[0];
        if (nav && nav.type === 'reload') {
            const url = new URL(window.location.href);
            if (url.searchParams.has('sort') || url.searchParams.has('dir')) {
                url.searchParams.delete('sort');
                url.searchParams.delete('dir');
                url.searchParams.delete('page');
                window.location.replace(url.toString());
            }
        }
    })();
</script>
{% endblock %}