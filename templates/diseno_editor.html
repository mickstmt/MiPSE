{% extends "base.html" %}

{% block title %}Diseñador de Comprobantes{% endblock %}

{% block content %}
<link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet">
<script src="https://unpkg.com/grapesjs"></script>
<script src="https://unpkg.com/grapesjs-preset-webpage"></script>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2 class="fw-bold mb-0"><i class="bi bi-palette me-2"></i> Diseñador Visual</h2>
        <p class="text-muted small mb-0">Personaliza el diseño de tus boletas electrónicas</p>
    </div>
    <div class="d-flex gap-2">
        <button id="btn-save" class="btn btn-primary fw-bold px-4 rounded-pill shadow-sm">
            <i class="bi bi-save me-1"></i> GUARDAR DISEÑO
        </button>
        <button id="btn-reset" class="btn btn-outline-secondary px-3 rounded-pill">
            <i class="bi bi-arrow-counterclockwise"></i> REGENERAR
        </button>
    </div>
</div>

<div class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div id="gjs" style="height: 700px; overflow: hidden;">
        <!-- El contenido se cargará aquí vía JS -->
    </div>
</div>

<style>
    /* Ajustes para que GrapesJS se vea bien dentro de nuestro layout */
    .gjs-cv-canvas {
        top: 0;
        width: 100%;
        height: 100%;
    }

    .gjs-block {
        width: auto;
        height: auto;
        min-height: auto;
    }

    .panel__right {
        flex-basis: 230px;
        position: relative;
        direction: ltr;
    }
</style>

<script>
    const editor = grapesjs.init({
        container: '#gjs',
        fromElement: true,
        height: '700px',
        width: 'auto',
        storageManager: false,
        plugins: ['gjs-preset-webpage'],
        pluginsOpts: {
            'gjs-preset-webpage': {}
        },
        deviceManager: {
            devices: [{
                name: 'A4',
                width: '210mm', // A4 Width
                height: '297mm',
                widthMedia: '210mm',
            }]
        }
    });

    // Cargar contenido inicial (template actual)
    const initialHtml = `{{ template.html_content|safe }}`;
    const initialCss = `{{ template.css_content|safe }}`;

    editor.setComponents(initialHtml);
    editor.setStyle(initialCss);

    // Botón Guardar
    document.getElementById('btn-save').addEventListener('click', function () {
        const html = editor.getHtml();
        const css = editor.getCss();

        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Guardando...';

        fetch("{{ url_for('guardar_diseno') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                html: html,
                css: css
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Diseño Guardado!',
                        text: 'Los nuevos PDFs usarán este diseño.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire('Error', data.message || 'Error al guardar', 'error');
                }
            })
            .catch(err => {
                console.error(err);
                Swal.fire('Error', 'Error de conexión', 'error');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-save me-1"></i> GUARDAR DISEÑO';
            });
    });

    // Bloques personalizados para la boleta
    const bm = editor.BlockManager;

    bm.add('header-ruc', {
        label: 'Recuadro RUC',
        content: `
            <div style="border: 2px solid black; padding: 10px; text-align: center; width: 200px;">
                <div style="font-weight: bold;">RUC: [[EMPRESA_RUC]]</div>
                <div style="background: #eee; font-weight: bold; margin: 5px 0;">BOLETA ELECTRÓNICA</div>
                <div style="font-weight: bold;">[[NRO_COMPROBANTE]]</div>
            </div>
        `,
        category: 'Componentes Boleta'
    });

    bm.add('tabla-items', {
        label: 'Tabla de Items',
        content: `
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead>
                    <tr style="background: black; color: white;">
                        <th style="border: 1px solid black; padding: 5px;">DESCRIPCIÓN</th>
                        <th style="border: 1px solid black; padding: 5px;">CANT.</th>
                        <th style="border: 1px solid black; padding: 5px;">P. UNIT</th>
                        <th style="border: 1px solid black; padding: 5px;">TOTAL</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid black; padding: 5px;">[[DETALLE_PRODUCTOS]]</td>
                    </tr>
                </tbody>
            </table>
        `,
        category: 'Componentes Boleta'
    });
</script>
{% endblock %}