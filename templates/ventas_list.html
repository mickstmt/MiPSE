{% extends "base.html" %}

{% block title %}Ventas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold mb-0"><i class="bi bi-receipt me-2 text-primary"></i> Lista de Ventas</h2>
    <div class="d-flex gap-2">
        <a href="{{ url_for('importar_cdrs') }}" class="btn btn-outline-secondary rounded-pill px-3" title="Subir CDRs descargados manualmente desde MiPSE">
            <i class="bi bi-cloud-upload me-1"></i> Importar CDRs
        </a>
        <button class="btn btn-outline-secondary rounded-pill px-3" onclick="recuperarCDRs()" title="Recuperar CDRs faltantes desde MiPSE">
            <i class="bi bi-cloud-download me-1"></i> Recuperar CDRs
        </button>
        <a href="{{ url_for('nueva_venta') }}" class="btn btn-primary rounded-pill px-4">
            <i class="bi bi-plus-circle me-1"></i> Nueva Venta
        </a>
    </div>
</div>

<!-- ====== PANEL DE BÃšSQUEDA Y FILTROS ====== -->
<div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-body p-3">
        <form method="GET" action="{{ url_for('ventas_list') }}" id="search-form">
            <input type="hidden" name="tipo_comprobante" value="{{ tipo_comprobante }}">
            <div class="row g-2 align-items-end">

                <!-- Selector de tipo de filtro -->
                <div class="col-12 col-md-3">
                    <label class="form-label text-muted small fw-semibold mb-1">
                        <i class="bi bi-funnel me-1"></i>Buscar por
                    </label>
                    <select class="form-select rounded-pill border-0 bg-light fw-semibold" name="tipo_filtro"
                        id="tipo_filtro" onchange="toggleSearchMode(this.value)">
                        <option value="dni" {% if tipo_filtro=='dni' %}selected{% endif %}>ðŸ“‹ DNI / RUC</option>
                        <option value="nombre" {% if tipo_filtro=='nombre' %}selected{% endif %}>ðŸ‘¤ Nombre del cliente
                        </option>
                        <option value="comprobante" {% if tipo_filtro=='comprobante' %}selected{% endif %}>ðŸ§¾ NÂ°
                            Comprobante</option>
                        <option value="orden" {% if tipo_filtro=='orden' %}selected{% endif %}>ðŸ“¦ NÂ° Orden</option>
                        <option value="fecha" {% if tipo_filtro=='fecha' %}selected{% endif %}>ðŸ“… Rango de fechas
                        </option>
                    </select>
                </div>

                <!-- Campo de texto (visible para dni, nombre, comprobante, orden) -->
                <div class="col-12 col-md-5" id="campo-texto" {% if tipo_filtro=='fecha' %}style="display:none" {% endif
                    %}>
                    <label class="form-label text-muted small fw-semibold mb-1">TÃ©rmino de bÃºsqueda</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0 text-muted rounded-start-pill">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control border-0 bg-light" name="q" value="{{ q }}"
                            id="campo-busqueda" placeholder="Escribe aquÃ­..." style="border-radius: 0 50px 50px 0;">
                    </div>
                </div>

                <!-- Rango de fechas (visible solo para filtro de fechas) -->
                <div class="col-12 col-md-5 d-flex gap-2" id="campo-fechas" {% if tipo_filtro !='fecha'
                    %}style="display:none" {% endif %}>
                    <div class="flex-fill">
                        <label class="form-label text-muted small fw-semibold mb-1">Desde</label>
                        <input type="date" class="form-control border-0 bg-light rounded-pill" name="fecha_desde"
                            value="{{ fecha_desde }}">
                    </div>
                    <div class="flex-fill">
                        <label class="form-label text-muted small fw-semibold mb-1">Hasta</label>
                        <input type="date" class="form-control border-0 bg-light rounded-pill" name="fecha_hasta"
                            value="{{ fecha_hasta }}">
                    </div>
                </div>

                <!-- Botones -->
                <div class="col-12 col-md-4 d-flex gap-2">
                    <button type="submit" class="btn btn-primary rounded-pill px-4 flex-fill fw-semibold">
                        <i class="bi bi-search me-1"></i> Buscar
                    </button>
                    {% if q or fecha_desde or fecha_hasta %}
                    <a href="{{ url_for('ventas_list', tipo_comprobante=tipo_comprobante) }}" class="btn btn-outline-secondary rounded-pill px-3"
                        title="Limpiar bÃºsqueda">
                        <i class="bi bi-x-lg"></i>
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Resumen de resultados -->
            {% if q or fecha_desde or fecha_hasta or tipo_comprobante %}
            <div class="mt-2 pt-2 border-top d-flex align-items-center gap-2 flex-wrap">
                <span class="badge bg-primary-subtle text-primary rounded-pill px-3 py-2 fw-semibold">
                    <i class="bi bi-list-check me-1"></i> {{ total_resultados }} resultado(s)
                </span>
                {% if tipo_comprobante %}
                <span class="text-muted small">Tipo: <strong>{{ 'Boletas' if tipo_comprobante == 'BOLETA' else 'Notas de CrÃ©dito' }}</strong></span>
                {% endif %}
                {% if q %}<span class="text-muted small">BÃºsqueda: <strong>"{{ q }}"</strong></span>{% endif %}
                {% if fecha_desde or fecha_hasta %}
                <span class="text-muted small">
                    Fechas: <strong>{{ fecha_desde or '...' }}</strong> â†’ <strong>{{ fecha_hasta or 'hoy' }}</strong>
                </span>
                {% endif %}
            </div>
            {% endif %}
        </form>
    </div>
</div>

<!-- ====== FILTRO RÃPIDO POR TIPO ====== -->
<div class="d-flex gap-2 mb-3">
    <a href="{{ url_for('ventas_list', q=q, tipo_filtro=tipo_filtro, fecha_desde=fecha_desde, fecha_hasta=fecha_hasta, sort=sort, dir=sort_dir) }}"
       class="btn rounded-pill px-4 fw-semibold {{ 'btn-primary' if not tipo_comprobante else 'btn-outline-secondary' }}">
        <i class="bi bi-list me-1"></i> Todas
    </a>
    <a href="{{ url_for('ventas_list', q=q, tipo_filtro=tipo_filtro, fecha_desde=fecha_desde, fecha_hasta=fecha_hasta, sort=sort, dir=sort_dir, tipo_comprobante='BOLETA') }}"
       class="btn rounded-pill px-4 fw-semibold {{ 'btn-primary' if tipo_comprobante == 'BOLETA' else 'btn-outline-secondary' }}">
        <i class="bi bi-receipt me-1"></i> Boletas
    </a>
    <a href="{{ url_for('ventas_list', q=q, tipo_filtro=tipo_filtro, fecha_desde=fecha_desde, fecha_hasta=fecha_hasta, sort=sort, dir=sort_dir, tipo_comprobante='NOTA_CREDITO') }}"
       class="btn rounded-pill px-4 fw-semibold {{ 'btn-primary' if tipo_comprobante == 'NOTA_CREDITO' else 'btn-outline-secondary' }}">
        <i class="bi bi-arrow-counterclockwise me-1"></i> Notas de CrÃ©dito
    </a>
</div>

<!-- ====== ACCIONES EN LOTE ====== -->
<div class="card border-0 shadow-sm rounded-4 mb-3" id="bulk-actions" style="display: none;">
    <div class="card-body py-2 px-3">
        <div class="d-flex justify-content-between align-items-center">
            <span id="selected-count" class="fw-bold text-primary small"></span>
            <div class="d-flex gap-2">
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary rounded-start-pill dropdown-toggle"
                        data-bs-toggle="dropdown">
                        <i class="bi bi-download me-1"></i> Descargar
                    </button>
                    <ul class="dropdown-menu shadow border-0">
                        <li><button class="dropdown-item" onclick="descargarLote('pdf')"><i
                                    class="bi bi-file-pdf me-2 text-danger"></i>PDFs (ZIP)</button></li>
                        <li><button class="dropdown-item" onclick="descargarLote('xml')"><i
                                    class="bi bi-file-code me-2 text-primary"></i>XMLs (ZIP)</button></li>
                        <li><button class="dropdown-item" onclick="descargarLote('cdr')"><i
                                    class="bi bi-file-check me-2 text-success"></i>CDRs (ZIP)</button></li>
                    </ul>
                </div>
                <button class="btn btn-sm btn-warning rounded-pill px-3" onclick="abrirModalNCLote()" title="Emitir Nota de CrÃ©dito a las boletas seleccionadas">
                    <i class="bi bi-file-earmark-minus me-1"></i> Emitir NCs
                </button>
                <button class="btn btn-sm btn-primary rounded-pill px-3" onclick="enviarSeleccionadas()">
                    <i class="bi bi-send me-1"></i> Enviar a SUNAT
                </button>
                <button class="btn btn-sm btn-danger rounded-pill px-3" onclick="eliminarSeleccionadas()">
                    <i class="bi bi-trash me-1"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

{% macro sort_th(label, col, extra_class='') %}
{% if sort == col and sort_dir == 'desc' %}
    {% set next_href = url_for('ventas_list', q=q, tipo_filtro=tipo_filtro, fecha_desde=fecha_desde, fecha_hasta=fecha_hasta, tipo_comprobante=tipo_comprobante, sort=col, dir='asc', page=1) %}
    {% set is_active = true %}
    {% set icon_class = 'bi-arrow-down' %}
{% elif sort == col and sort_dir == 'asc' %}
    {% set next_href = url_for('ventas_list', q=q, tipo_filtro=tipo_filtro, fecha_desde=fecha_desde, fecha_hasta=fecha_hasta, tipo_comprobante=tipo_comprobante, page=1) %}
    {% set is_active = true %}
    {% set icon_class = 'bi-arrow-up' %}
{% else %}
    {% set next_href = url_for('ventas_list', q=q, tipo_filtro=tipo_filtro, fecha_desde=fecha_desde, fecha_hasta=fecha_hasta, tipo_comprobante=tipo_comprobante, sort=col, dir='desc', page=1) %}
    {% set is_active = false %}
    {% set icon_class = 'bi-arrow-down-up' %}
{% endif %}
<th class="py-3 {{ extra_class }} sort-th {{ 'sort-active' if is_active }}">
    <a href="{{ next_href }}"
       class="sort-link {{ 'text-primary fw-semibold' if is_active else 'text-muted' }}">
        {{ label }}
        <i class="bi {{ icon_class }} ms-1 {{ '' if is_active else 'opacity-25' }}"></i>
    </a>
</th>
{% endmacro %}

<!-- ====== TABLA DE VENTAS ====== -->
<div class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light bg-opacity-75">
                    <tr>
                        <th class="ps-3 py-3" width="48">
                            <input type="checkbox" id="select-all" class="big-check" onchange="toggleSelectAll(this)">
                        </th>
                        {{ sort_th('NÂ° Orden', 'orden') }}
                        {{ sort_th('Comprobante', 'comprobante') }}
                        {{ sort_th('Cliente', 'cliente') }}
                        <th class="py-3 text-muted small text-uppercase">Documento</th>
                        {{ sort_th('Total', 'total') }}
                        {{ sort_th('Estado', 'estado') }}
                        {{ sort_th('Fecha', 'fecha') }}
                        <th class="pe-3 py-3 text-muted small text-uppercase text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for venta in ventas %}
                    <tr>
                        <td class="p-0" style="cursor:pointer" onclick="toggleRow(this)">
                            <div class="d-flex align-items-center justify-content-center"
                                style="width:48px;height:100%;min-height:50px;">
                                <input type="checkbox" class="venta-checkbox big-check" value="{{ venta.id }}"
                                    onchange="updateSelectedCount()" onclick="event.stopPropagation()">
                            </div>
                        </td>
                        <td>
                            {% if venta.numero_orden %}
                            <span class="badge bg-info-subtle text-info rounded-pill px-2">{{ venta.numero_orden
                                }}</span>
                            {% else %}
                            <span class="text-muted">â€”</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="fw-bold">{{ venta.numero_completo }}</span>
                            {% if venta.tipo_comprobante == 'NOTA_CREDITO' %}
                            <span class="badge bg-warning text-dark ms-1" title="Nota de CrÃ©dito">NC</span>
                            {% endif %}
                        </td>
                        <td>{{ venta.cliente.nombre_completo }}</td>
                        <td><span class="text-muted small">{{ venta.cliente.tipo_documento }}: {{
                                venta.cliente.numero_documento }}</span></td>
                        <td><strong class="text-success">S/ {{ "%.2f"|format(venta.total) }}</strong></td>
                        <td>
                            {% if venta.estado == 'BORRADOR' %}
                            <span class="badge bg-secondary-subtle text-secondary rounded-pill px-2">Borrador</span>
                            {% elif venta.estado == 'PENDIENTE' %}
                            <span class="badge bg-warning-subtle text-warning rounded-pill px-2"><i
                                    class="bi bi-clock me-1"></i>Pendiente</span>
                            {% elif venta.estado == 'ENVIADO' %}
                            <span class="badge bg-success-subtle text-success rounded-pill px-2"><i
                                    class="bi bi-check-circle me-1"></i>Enviado</span>
                            {% elif venta.estado == 'ACEPTADO' %}
                            <span class="badge bg-success-subtle text-success rounded-pill px-2">Aceptado</span>
                            {% elif venta.estado == 'RECHAZADO' %}
                            <span class="badge bg-danger-subtle text-danger rounded-pill px-2">Rechazado</span>
                            {% endif %}
                        <td class="small text-muted">{{ venta.fecha_emision.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td class="pe-3 text-end">
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('ver_venta', venta_id=venta.id) }}"
                                    class="btn btn-outline-info rounded-start-pill" title="Ver detalles">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{{ url_for('descargar_pdf', venta_id=venta.id) }}"
                                    class="btn btn-outline-primary" title="Imprimir" target="_blank">
                                    <i class="bi bi-printer"></i>
                                </a>
                                {% if venta.estado == 'PENDIENTE' %}
                                <button class="btn btn-outline-primary" title="Enviar a SUNAT"
                                    onclick="enviarSunat({{ venta.id }}, '{{ venta.numero_completo }}')">
                                    <i class="bi bi-send"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-danger rounded-end-pill" title="Eliminar"
                                    onclick="eliminarVenta({{ venta.id }}, '{{ venta.numero_completo }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center py-5">
                            <div class="text-muted">
                                <i class="bi bi-search display-4 d-block mb-3 opacity-30"></i>
                                {% if q or fecha_desde %}
                                <p class="fw-semibold">No se encontraron ventas con ese criterio</p>
                                <a href="{{ url_for('ventas_list') }}"
                                    class="btn btn-outline-primary rounded-pill px-4 mt-1">
                                    <i class="bi bi-arrow-left me-1"></i> Ver todas las ventas
                                </a>
                                {% else %}
                                <p class="fw-semibold">No hay ventas registradas aÃºn</p>
                                <a href="{{ url_for('nueva_venta') }}" class="btn btn-primary rounded-pill px-4 mt-1">
                                    <i class="bi bi-plus-circle me-1"></i> Crear primera venta
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ====== PAGINACIÃ“N ====== -->
    {% if pagination and pagination.pages > 1 %}
    <div class="d-flex justify-content-between align-items-center px-4 py-3 border-top bg-light bg-opacity-50">
        <span class="text-muted small">
            Mostrando <strong>{{ (pagination.page - 1) * 25 + 1 }}â€“{{ [(pagination.page * 25), pagination.total] | min }}</strong>
            de <strong>{{ pagination.total }}</strong> ventas
        </span>
        <nav>
            <ul class="pagination pagination-sm mb-0 gap-1">
                <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                    <a class="page-link rounded-3 border-0 {{ 'text-muted' if not pagination.has_prev }}"
                       href="{{ url_for('ventas_list', q=q, tipo_filtro=tipo_filtro, fecha_desde=fecha_desde, fecha_hasta=fecha_hasta, tipo_comprobante=tipo_comprobante, sort=sort, dir=sort_dir, page=pagination.prev_num) if pagination.has_prev else '#' }}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
                {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if p %}
                        <li class="page-item {{ 'active' if p == pagination.page }}">
                            <a class="page-link rounded-3 border-0 fw-semibold"
                               href="{{ url_for('ventas_list', q=q, tipo_filtro=tipo_filtro, fecha_desde=fecha_desde, fecha_hasta=fecha_hasta, tipo_comprobante=tipo_comprobante, sort=sort, dir=sort_dir, page=p) }}">
                                {{ p }}
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link border-0 bg-transparent px-1">â€¦</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                    <a class="page-link rounded-3 border-0 {{ 'text-muted' if not pagination.has_next }}"
                       href="{{ url_for('ventas_list', q=q, tipo_filtro=tipo_filtro, fecha_desde=fecha_desde, fecha_hasta=fecha_hasta, tipo_comprobante=tipo_comprobante, sort=sort, dir=sort_dir, page=pagination.next_num) if pagination.has_next else '#' }}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<style>
    .bg-info-subtle {
        background-color: rgba(13, 202, 240, 0.12) !important;
    }

    .bg-success-subtle {
        background-color: rgba(25, 135, 84, 0.1) !important;
    }

    .bg-warning-subtle {
        background-color: rgba(255, 193, 7, 0.12) !important;
    }

    .bg-danger-subtle {
        background-color: rgba(220, 53, 69, 0.1) !important;
    }

    .bg-secondary-subtle {
        background-color: rgba(108, 117, 125, 0.1) !important;
    }

    .bg-primary-subtle {
        background-color: rgba(13, 110, 253, 0.1) !important;
    }

    tr:hover {
        background-color: rgba(0, 0, 0, 0.012) !important;
    }

    .sort-link {
        text-decoration: none;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        display: inline-flex;
        align-items: center;
        gap: 2px;
        transition: color 0.15s;
    }
    .sort-link:hover { color: #0d6efd !important; }
    .sort-link i { font-size: 0.65rem; }

    .pagination .page-link {
        background-color: #fff;
        color: #6c757d;
        min-width: 32px;
        text-align: center;
        transition: all 0.15s;
    }
    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        color: #fff;
    }
    .pagination .page-link:hover:not(.disabled) {
        background-color: #e9f0ff;
        color: #0d6efd;
    }
</style>

<script>
    // ====== RESET SORT ON BROWSER RELOAD ======
    (function () {
        const nav = performance.getEntriesByType('navigation')[0];
        if (nav && nav.type === 'reload') {
            const url = new URL(window.location.href);
            if (url.searchParams.has('sort') || url.searchParams.has('dir')) {
                url.searchParams.delete('sort');
                url.searchParams.delete('dir');
                url.searchParams.delete('page');
                window.location.replace(url.toString());
            }
        }
    })();

    // ====== LÃ“GICA DEL BUSCADOR ======
    function toggleRow(cell) {
        const cb = cell.querySelector('.venta-checkbox');
        cb.checked = !cb.checked;
        updateSelectedCount();
    }

    function toggleSearchMode(tipo) {
        const campoTexto = document.getElementById('campo-texto');
        const campoFechas = document.getElementById('campo-fechas');
        if (tipo === 'fecha') {
            campoTexto.style.display = 'none';
            campoFechas.style.display = 'flex';
        } else {
            campoTexto.style.display = '';
            campoFechas.style.display = 'none';
            document.getElementById('campo-busqueda').focus();
        }
    }

    // Actualizar placeholder segÃºn el tipo de filtro
    document.getElementById('tipo_filtro').addEventListener('change', function () {
        const placeholders = {
            dni: 'Ej: 12345678',
            nombre: 'Ej: Juan PÃ©rez',
            comprobante: 'Ej: B001-00000123',
            orden: 'Ej: 100123456',
        };
        const input = document.getElementById('campo-busqueda');
        if (input) input.placeholder = placeholders[this.value] || 'Escribe aquÃ­...';
    });

    // ====== ACCIONES EN LOTE ======
    function descargarLote(tipo) {
        const checkboxes = document.querySelectorAll('.venta-checkbox:checked');
        const ventaIds = Array.from(checkboxes).map(cb => cb.value);
        if (ventaIds.length === 0) { alert('No hay ventas seleccionadas'); return; }
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('download_bulk') }}";
        const inputIds = document.createElement('input');
        inputIds.type = 'hidden'; inputIds.name = 'venta_ids'; inputIds.value = JSON.stringify(ventaIds);
        form.appendChild(inputIds);
        const inputTipo = document.createElement('input');
        inputTipo.type = 'hidden'; inputTipo.name = 'tipo_archivo'; inputTipo.value = tipo;
        form.appendChild(inputTipo);
        document.body.appendChild(form); form.submit(); document.body.removeChild(form);
        setTimeout(() => { document.querySelectorAll('.venta-checkbox').forEach(cb => cb.checked = false); updateSelectedCount(); }, 100);
    }

    function enviarSunat(ventaId, numeroCompleto) {
        if (confirm(`Â¿Enviar la boleta ${numeroCompleto} a SUNAT?`)) {
            const form = document.createElement('form');
            form.method = 'POST'; form.action = `/venta/${ventaId}/enviar-sunat`;
            document.body.appendChild(form); form.submit();
        }
    }

    function eliminarVenta(ventaId, numeroCompleto) {
        if (confirm(`Â¿Eliminar la venta ${numeroCompleto}?\n\nEsta acciÃ³n no se puede deshacer.`)) {
            fetch(`/venta/${ventaId}/eliminar`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } })
                .then(r => r.json()).then(data => {
                    if (data.success) { showToast('Eliminado', 'Venta eliminada exitosamente', 'success'); setTimeout(() => location.reload(), 1000); }
                    else alert('Error: ' + data.message);
                });
        }
    }

    function enviarSeleccionadas() {
        const ventaIds = Array.from(document.querySelectorAll('.venta-checkbox:checked')).map(cb => cb.value);
        if (ventaIds.length === 0) { alert('No hay ventas seleccionadas'); return; }
        if (confirm(`Â¿Enviar ${ventaIds.length} venta(s) a SUNAT?`)) {
            fetch('/ventas/enviar-lote', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ venta_ids: ventaIds }) })
                .then(r => r.json()).then(data => { if (data.success) { alert(`${data.enviadas} enviada(s) exitosamente`); location.reload(); } else alert('Error: ' + data.message); });
        }
    }

    function eliminarSeleccionadas() {
        const ventaIds = Array.from(document.querySelectorAll('.venta-checkbox:checked')).map(cb => cb.value);
        if (ventaIds.length === 0) { alert('No hay ventas seleccionadas'); return; }
        if (confirm(`Â¿Eliminar ${ventaIds.length} venta(s)?\n\nEsta acciÃ³n no se puede deshacer.`)) {
            fetch('/ventas/eliminar-lote', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ venta_ids: ventaIds }) })
                .then(r => r.json()).then(data => { if (data.success) { alert(`${data.eliminadas} eliminada(s) exitosamente`); location.reload(); } else alert('Error: ' + data.message); });
        }
    }

    function updateSelectedCount() {
        const count = document.querySelectorAll('.venta-checkbox:checked').length;
        const bulkActions = document.getElementById('bulk-actions');
        const selectedCount = document.getElementById('selected-count');
        if (count > 0) { bulkActions.style.display = 'block'; selectedCount.textContent = `${count} venta(s) seleccionada(s)`; }
        else { bulkActions.style.display = 'none'; }
    }

    function toggleSelectAll(checkbox) {
        document.querySelectorAll('.venta-checkbox').forEach(cb => cb.checked = checkbox.checked);
        updateSelectedCount();
    }

    // ====== NOTAS DE CRÃ‰DITO EN LOTE ======
    function abrirModalNCLote() {
        const ids = Array.from(document.querySelectorAll('.venta-checkbox:checked')).map(cb => cb.value);
        if (ids.length === 0) { alert('No hay ventas seleccionadas'); return; }
        document.getElementById('nc-lote-count').textContent = ids.length;
        document.getElementById('nc-lote-motivo').value = '';
        new bootstrap.Modal(document.getElementById('modalNCLote')).show();
    }

    async function confirmarNCLote() {
        const motivo = document.getElementById('nc-lote-motivo');
        if (!motivo.value) { motivo.focus(); motivo.reportValidity(); return; }

        const ids     = Array.from(document.querySelectorAll('.venta-checkbox:checked')).map(cb => cb.value);
        const motivoTexto = motivo.options[motivo.selectedIndex].text;

        // 1. ConfirmaciÃ³n
        const confirm = await Swal.fire({
            title: 'Â¿Confirmar emisiÃ³n masiva?',
            html: `Se emitirÃ¡n Notas de CrÃ©dito para <strong>${ids.length}</strong> venta(s).<br>
                   <small class="text-muted">Motivo: ${motivoTexto}</small><br><br>
                   <span class="text-warning fw-semibold"><i class="bi bi-exclamation-triangle me-1"></i>
                   Solo se procesarÃ¡n boletas con estado <strong>Enviado</strong> y sin NC previa.
                   Esta acciÃ³n no se puede deshacer.</span>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ffc107',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '<i class="bi bi-file-earmark-minus me-1"></i> SÃ­, emitir NCs',
            cancelButtonText: 'Cancelar'
        });
        if (!confirm.isConfirmed) return;

        // 2. Cerrar modal de motivo y abrir modal de progreso
        bootstrap.Modal.getInstance(document.getElementById('modalNCLote')).hide();

        const btnConfirmar = document.getElementById('btn-confirmar-nc-lote');
        btnConfirmar.disabled = true;

        // Reset modal de progreso
        document.getElementById('nc-prog-spinner').classList.remove('d-none');
        document.getElementById('nc-prog-ok-icon').classList.add('d-none');
        document.getElementById('nc-prog-title').textContent = 'Emitiendo Notas de CrÃ©dito...';
        document.getElementById('nc-prog-msg').textContent = 'Enviando a SUNAT, por favor espere.';
        document.getElementById('nc-prog-bar').style.width = '0%';
        document.getElementById('nc-prog-bar').className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
        document.getElementById('nc-prog-pct').textContent = '0%';
        document.getElementById('nc-prog-text').textContent = 'Iniciando...';
        document.getElementById('nc-prog-stat-ok').textContent = '0';
        document.getElementById('nc-prog-stat-err').textContent = '0';
        document.getElementById('nc-prog-container').classList.remove('d-none');
        document.getElementById('nc-prog-btn-finish').classList.add('d-none');
        document.getElementById('nc-prog-errores').innerHTML = '';
        document.getElementById('nc-prog-errores').classList.add('d-none');

        const progressModal = new bootstrap.Modal(document.getElementById('modalNCProgress'));
        progressModal.show();

        // 3. Procesar uno a uno con progreso en tiempo real
        let creadas = 0;
        const errores = [];
        const total   = ids.length;

        for (let i = 0; i < total; i++) {
            const pct = Math.round(((i + 1) / total) * 100);
            document.getElementById('nc-prog-text').textContent = `Procesando ${i + 1} de ${total}...`;
            try {
                const res  = await fetch('/ventas/nc-lote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ venta_ids: [ids[i]], motivo_codigo: motivo.value })
                });
                const data = await res.json();
                if (data.success && data.creadas > 0) {
                    creadas++;
                } else {
                    (data.errores || [{ numero: ids[i], error: data.message || 'Error desconocido' }])
                        .forEach(e => errores.push(e));
                }
            } catch (e) {
                errores.push({ numero: ids[i], error: 'Error de red' });
            }
            document.getElementById('nc-prog-bar').style.width      = `${pct}%`;
            document.getElementById('nc-prog-pct').textContent       = `${pct}%`;
            document.getElementById('nc-prog-stat-ok').textContent   = creadas;
            document.getElementById('nc-prog-stat-err').textContent  = errores.length;
        }

        // 4. Estado final
        document.getElementById('nc-prog-container').classList.add('d-none');
        document.getElementById('nc-prog-spinner').classList.add('d-none');
        document.getElementById('nc-prog-ok-icon').classList.remove('d-none');
        document.getElementById('nc-prog-title').textContent = 'Â¡Proceso Completado!';
        document.getElementById('nc-prog-msg').textContent   = `${creadas} NC(s) emitida(s) exitosamente.`;
        document.getElementById('nc-prog-bar').classList.remove('progress-bar-animated', 'progress-bar-striped', 'bg-warning');
        document.getElementById('nc-prog-bar').classList.add(errores.length === 0 ? 'bg-success' : 'bg-warning');
        document.getElementById('nc-prog-btn-finish').classList.remove('d-none');
        btnConfirmar.disabled = false;

        if (errores.length > 0) {
            const ul = errores.map(e => `<li><strong>${e.numero}</strong>: ${e.error}</li>`).join('');
            document.getElementById('nc-prog-errores').innerHTML =
                `<details class="mt-3"><summary class="small text-muted" style="cursor:pointer">
                 ${errores.length} omitida(s) â€” ver detalle</summary>
                 <ul class="text-start small mt-2 mb-0">${ul}</ul></details>`;
            document.getElementById('nc-prog-errores').classList.remove('d-none');
        }

        if (errores.length === 0 && creadas > 0) {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }
    }

    function recuperarCDRs() {
        Swal.fire({
            title: 'Â¿Recuperar CDRs faltantes?',
            html: 'Se intentarÃ¡ descargar desde MiPSE los CDRs de todos los documentos enviados que no tienen archivo local.<br><br>Esto puede tardar unos segundos.',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'SÃ­, recuperar',
            cancelButtonText: 'Cancelar'
        }).then(result => {
            if (!result.isConfirmed) return;
            Swal.fire({
                title: 'Recuperando CDRs...',
                html: 'Consultando MiPSE. Por favor espere.',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => Swal.showLoading()
            });
            fetch('{{ url_for("recuperar_cdrs_masivo") }}', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    const noDisp = data.fallidos > 0
                        ? `<br><strong>${data.fallidos}</strong> no encontrados en API de MiPSE<br><small class="text-muted">(MiPSE no almacena documentos histÃ³ricos vÃ­a API â€” descÃ¡rgalos manualmente desde el portal de MiPSE)</small>`
                        : '';
                    Swal.fire({
                        icon: data.recuperados > 0 ? 'success' : 'info',
                        title: 'RecuperaciÃ³n completada',
                        html: `<strong>${data.recuperados}</strong> recuperado(s) exitosamente<br>
                               <strong>${data.omitidos}</strong> ya existÃ­an localmente${noDisp}`
                    });
                })
                .catch(() => Swal.fire('Error', 'No se pudo conectar con el servidor.', 'error'));
        });
    }
</script>

{% endblock %}

{% block modals %}
<!-- ====== MODAL: PROGRESO NC EN LOTE ====== -->
<div class="modal fade" id="modalNCProgress" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow">
            <div class="modal-body text-center p-5">
                <div id="nc-prog-spinner" class="mb-4">
                    <div class="spinner-border text-warning" style="width: 3rem; height: 3rem;"></div>
                </div>
                <div id="nc-prog-ok-icon" class="mb-4 d-none">
                    <div class="bg-success bg-opacity-10 text-success rounded-circle d-inline-flex align-items-center justify-content-center"
                         style="width: 80px; height: 80px;">
                        <i class="bi bi-check-lg fs-1"></i>
                    </div>
                </div>
                <h3 class="fw-bold" id="nc-prog-title">Emitiendo Notas de CrÃ©dito...</h3>
                <p class="text-muted mb-4" id="nc-prog-msg">Enviando a SUNAT, por favor espere.</p>

                <div id="nc-prog-container" class="mb-4">
                    <div class="progress rounded-pill shadow-sm" style="height: 12px;">
                        <div id="nc-prog-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2 small fw-bold">
                        <span id="nc-prog-text" class="text-warning">Iniciando...</span>
                        <span id="nc-prog-pct" class="text-muted">0%</span>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-6">
                        <div class="h2 fw-bold text-success mb-0" id="nc-prog-stat-ok">0</div>
                        <div class="small text-muted text-uppercase fw-bold">Emitidas</div>
                    </div>
                    <div class="col-6">
                        <div class="h2 fw-bold text-danger mb-0" id="nc-prog-stat-err">0</div>
                        <div class="small text-muted text-uppercase fw-bold">Omitidas</div>
                    </div>
                </div>

                <div id="nc-prog-errores" class="d-none"></div>

                <div class="mt-4 d-none" id="nc-prog-btn-finish">
                    <button class="btn btn-primary btn-lg w-100 rounded-3 fw-bold py-3" onclick="location.reload()">
                        <i class="bi bi-list-check me-2"></i>IR A LISTA DE VENTAS
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ====== MODAL: MOTIVO NC EN LOTE ====== -->
<div class="modal fade" id="modalNCLote" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header border-0 pb-0 px-4 pt-4">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-file-earmark-minus text-warning me-2"></i>Emitir Notas de CrÃ©dito en lote
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4 py-3">
                <div class="alert alert-warning d-flex gap-2 align-items-start py-2">
                    <i class="bi bi-exclamation-triangle-fill flex-shrink-0 mt-1"></i>
                    <div class="small">
                        Se procesarÃ¡n <strong id="nc-lote-count">0</strong> venta(s) seleccionada(s).
                        Solo se emitirÃ¡n NCs para boletas con estado <strong>Enviado</strong> y sin NC previa.
                        Las demÃ¡s serÃ¡n omitidas con detalle.
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        Motivo <span class="text-danger">*</span>
                        <small class="text-muted fw-normal">(SUNAT CatÃ¡logo 09)</small>
                    </label>
                    <select id="nc-lote-motivo" class="form-select rounded-3" required>
                        <option value="" disabled selected>â€” Seleccione el motivo â€”</option>
                        {% for codigo, descripcion in motivos_nc.items() %}
                        <option value="{{ codigo }}">{{ codigo }} â€” {{ descripcion }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer border-0 px-4 pb-4 pt-0 gap-2">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning rounded-pill px-4 fw-semibold" id="btn-confirmar-nc-lote" onclick="confirmarNCLote()">
                    <i class="bi bi-file-earmark-minus me-1"></i> Continuar
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
{% endblock %}